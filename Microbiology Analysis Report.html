<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Microbiology Analysis Report — Heritage Foods Ltd</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; color: #222; }
  h1 { font-size: 20px; margin-bottom: 16px; }

  .meta-grid {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 12px; background: #fff; padding: 12px;
    border: 1px solid #ccc; border-radius: 6px;
  }
  .meta-grid label { font-size: 13px; color: #555; display: block; }
  .meta-grid input {
    width: 100%; padding: 6px 8px; border: 1px solid #ccc;
    border-radius: 6px; margin-top: 4px;
  }

  .toolbar { margin: 16px 0; display: flex; flex-wrap: wrap; gap: 10px; }
  button, label.buttonlike {
    padding: 8px 14px; border-radius: 6px; cursor: pointer;
    border: 1px solid #0b7dda; background: #0b7dda; color: #fff;
    font-weight: bold;
  }
  button.secondary, label.buttonlike.secondary {
    background: #fff; color: #0b7dda;
  }
  input[type="file"] { display: none; }

  table {
    width: 100%; border-collapse: collapse; background: #fff;
    border: 1px solid #ccc; margin-top: 10px;
  }
  th {
    background: #e8f1ff; padding: 10px; border-bottom: 1px solid #ccc;
    text-align: left; font-size: 14px;
  }
  td { padding: 6px; border-top: 1px solid #ddd; }
  td input {
    width: 100%; padding: 6px 8px; border: 1px solid #ccc;
    border-radius: 6px; font-size: 14px;
  }

  .delete-btn {
    background: #d9534f;
    color: #fff;
    border: none;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
  }
  .delete-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .status { margin-top: 10px; font-size: 13px; color: #444; }

  @media print {
    .toolbar, .status, .delete-btn { display: none; }
  }
</style>
</head>

<body>

<h1>HERITAGE FOODS LIMITED — Microbiology Analysis Report</h1>

<section class="meta-grid">
  <div><label>ISSUE No.<input id="issueNo" value="02"></label></div>
  <div><label>REV. DATE<input id="revDate" value="01.07.2017"></label></div>
  <div><label>REF. NO.<input id="refNo" value="HFL/QA/PS/R-10"></label></div>
  <div><label>Date<input type="date" id="recordDate"></label></div>
  <div><label>Report title<input id="reportTitle" value="Microbiology Analysis Report"></label></div>
  <div><label>Location/Plant<input id="location"></label></div>
</section>

<div class="toolbar">
  <button id="addRowBtn">Add row</button>
  <button id="saveBtn">Save</button>
  <label class="buttonlike secondary" for="loadInput">Load</label>
  <input type="file" id="loadInput" accept=".json">
  <button class="secondary" id="printBtn">Print</button>
  <label class="buttonlike secondary">
    <input type="checkbox" id="lockToggle"> Lock record
  </label>
</div>

<table>
  <thead>
    <tr>
      <th>SOURCE</th>
      <th>LOT NO</th>
      <th>COLIFORMS / g</th>
      <th>TBC / g</th>
      <th>YEAST / g</th>
      <th>MOULD / g</th>
      <th>REMARKS</th>
      <th>Tested by</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="mbBody"></tbody>
</table>

<div class="status" id="status">Record status: Unlocked</div>

<script>
(function(){

  const mbBody = document.getElementById("mbBody");
  const addRowBtn = document.getElementById("addRowBtn");
  const saveBtn = document.getElementById("saveBtn");
  const loadInput = document.getElementById("loadInput");
  const printBtn = document.getElementById("printBtn");
  const lockToggle = document.getElementById("lockToggle");
  const statusEl = document.getElementById("status");

  const metaIds = ["issueNo","revDate","refNo","recordDate","reportTitle","location"];

  function escapeVal(v){ return v ? String(v).replace(/"/g,"&quot;") : ""; }

  function addRow(data = {}) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input name="source" value="${escapeVal(data.source)}"></td>
      <td><input name="lotNo" value="${escapeVal(data.lotNo)}"></td>
      <td><input type="number" name="coliforms" min="0" value="${escapeVal(data.coliforms)}"></td>
      <td><input type="number" name="tbc" min="0" value="${escapeVal(data.tbc)}"></td>
      <td><input type="number" name="yeast" min="0" value="${escapeVal(data.yeast)}"></td>
      <td><input type="number" name="mould" min="0" value="${escapeVal(data.mould)}"></td>
      <td><input name="remarks" value="${escapeVal(data.remarks)}"></td>
      <td><input name="testedBy" value="${escapeVal(data.testedBy)}"></td>
      <td><button type="button" class="delete-btn">Delete</button></td>
    `;
    mbBody.appendChild(tr);
    applyLock(lockToggle.checked);
  }

  function serialize() {
    const meta = {};
    metaIds.forEach(id => meta[id] = document.getElementById(id).value);

    const rows = [];
    mbBody.querySelectorAll("tr").forEach(tr => {
      const row = {};
      tr.querySelectorAll("input").forEach(f => {
        // ignore the lock checkbox in meta section automatically
        if (f.name) row[f.name] = f.value;
      });
      rows.push(row);
    });

    return {
      schema: "HFL-QA-MB-v2",
      savedAt: new Date().toISOString(),
      locked: lockToggle.checked,
      meta,
      rows
    };
  }

  function populate(data) {
    metaIds.forEach(id => {
      document.getElementById(id).value = data.meta?.[id] ?? "";
    });

    mbBody.innerHTML = "";
    (data.rows || []).forEach(r => addRow(r));

    lockToggle.checked = !!data.locked;
    applyLock(lockToggle.checked);
    updateStatus();
  }

  function downloadJSON(filename, data) {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  function buildFilename() {
    const d = document.getElementById("recordDate").value || new Date().toISOString().slice(0,10);
    const ref = (document.getElementById("refNo").value || "HFL-QA-PS-R-10").replace(/\s+/g,"");
    return `${ref}_MB_${d}.json`;
  }

  function applyLock(locked) {
    // Disable all inputs except the lock checkbox itself
    document.querySelectorAll("input").forEach(i => {
      if (i !== lockToggle) i.disabled = locked;
    });
    // Disable/enable Add row and Delete buttons
    addRowBtn.disabled = locked;
    mbBody.querySelectorAll(".delete-btn").forEach(btn => btn.disabled = locked);
  }

  function updateStatus() {
    statusEl.textContent = lockToggle.checked ? "Record status: Locked" : "Record status: Unlocked";
  }

  // ✅ Delete row when clicking Delete button
  mbBody.addEventListener("click", function(e) {
    if (e.target.classList.contains("delete-btn")) {
      const row = e.target.closest("tr");
      if (row) row.remove();
    }
  });

  // ✅ Arrow‑key navigation (Up/Down/Left/Right) + auto‑add row on ↓ from last row
  mbBody.addEventListener("keydown", function(e){
    const key = e.key;
    if (!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(key)) return;

    const current = e.target;
    if (current.tagName !== "INPUT") return;

    const td = current.closest("td");
    const tr = current.closest("tr");
    const colIndex = Array.from(tr.children).indexOf(td);
    const rows = Array.from(mbBody.querySelectorAll("tr"));
    const rowIndex = rows.indexOf(tr);

    let targetRow = rowIndex;
    let targetCol = colIndex;

    if (key === "ArrowUp") targetRow--;
    if (key === "ArrowDown") targetRow++;
    if (key === "ArrowLeft") targetCol--;
    if (key === "ArrowRight") targetCol++;

    // Auto‑add row when pressing ↓ on last row (before Action column)
    if (key === "ArrowDown" && targetRow >= rows.length) {
      addRow();
      targetRow = rows.length; // index of newly added row
    }

    // Prevent moving into the Action button cell via arrows
    const maxInputColIndex = tr.children.length - 2; // last input column index
    if (targetCol < 0 || targetCol > maxInputColIndex) return;
    if (targetRow < 0 || targetRow >= mbBody.rows.length) return;

    const targetInput = mbBody.rows[targetRow].children[targetCol].querySelector("input");
    if (targetInput) {
      e.preventDefault();
      targetInput.focus();
      targetInput.select();
    }
  });

  // Events
  addRowBtn.onclick = () => addRow();
  saveBtn.onclick = () => downloadJSON(buildFilename(), serialize());
  loadInput.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try { populate(JSON.parse(reader.result)); }
      catch { alert("Invalid file. Load a JSON saved from this report."); }
      loadInput.value = "";
    };
    reader.readAsText(file);
  };
  printBtn.onclick = () => window.print();
  lockToggle.onchange = () => {
    applyLock(lockToggle.checked);
    updateStatus();
  };

  // Initialize with 3 rows and today's date
  for (let i = 0; i < 3; i++) addRow();
  const dateEl = document.getElementById("recordDate");
  if (!dateEl.value) dateEl.value = new Date().toISOString().slice(0,10);
  updateStatus();

})();
</script>

</body>
</html>