<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Media Consumption System</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --primary:#1f4fd8;
  --danger:#dc2626;
  --success:#16a34a;
  --border:#e5e7eb;
  --card:#ffffff;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI, system-ui, sans-serif;
  background:#f3f4f6;
  padding:20px;
}
header,.card{
  background:var(--card);
  border-radius:14px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  padding:18px;
  margin-bottom:16px;
}
h1{margin:0;font-size:1.3rem;color:#1e3a8a}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
button,label{
  border:none;
  border-radius:10px;
  padding:9px 14px;
  font-weight:600;
  cursor:pointer;
}
.add{background:var(--primary);color:#fff}
.delete{background:var(--danger);color:#fff}
.save{background:var(--success);color:#fff}
.report{background:#64748b;color:#fff}
label{background:#e0e7ff}
input[type=file]{display:none}
input,textarea{
  padding:7px;
  border-radius:8px;
  border:1px solid var(--border);
}
table{width:100%;border-collapse:collapse;font-size:.9rem}
th,td{padding:8px;border-bottom:1px solid var(--border)}
thead th{background:#e0e7ff;position:sticky;top:0}
tr.negative{background:#fee2e2}
.table-wrap{max-height:65vh;overflow:auto}
@media print{
  body *{visibility:hidden}
  #printArea,#printArea *{visibility:visible}
  #printArea{position:absolute;left:0;top:0;width:100%}
}
</style>
</head>

<body>

<header>
<h1>HERITAGE FOODS LIMITED â€” Media Consumption</h1>
<div class="toolbar">
  <button class="add" id="addRow">âž• Add Row</button>
  <button class="add" id="addDay">ðŸ“… Add Next Day</button>
  <button class="delete" id="deleteSelected">ðŸ—‘ Delete</button>
  <button class="save" id="saveJson">ðŸ’¾ Save</button>
  <label for="fileLoader">ðŸ“‚ Load</label>
  <input type="file" id="fileLoader" accept="application/json">
</div>
</header>

<!-- REPORT CONTROLS -->
<div class="card">
<strong>ðŸ“Š Reports</strong>
<div class="toolbar">
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button class="report" id="mediaSummary">Media-wise Summary</button>
  <button class="report" id="monthlyReport">Monthly Report</button>
  <button class="report" onclick="window.print()">ðŸ–¨ Print</button>
</div>
<div id="printArea"></div>
</div>

<!-- DATA TABLE -->
<div class="card">
<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Date</th>
  <th>Media</th>
  <th>Batch Code / Expiry</th>
  <th>Opening</th>
  <th>Consumed</th>
  <th>Receipt</th>
  <th>Closing</th>
  <th>Select</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<script>
const tbody=document.getElementById("tbody");

/* Decimal-safe helpers */
const toInt=v=>Math.round((parseFloat(v)||0)*1000);
const toDec=v=>(v/1000).toFixed(3);

/* Recalculate row */
function recalc(tr){
  const o=toInt(tr.o.value);
  const c=toInt(tr.c.value);
  const r=toInt(tr.r.value);
  const close=o-c+r;
  tr.cl.value=toDec(close);
  tr.classList.toggle("negative",close<0);
  syncNextDay(tr);
}

/* Sync next day opening */
function syncNextDay(tr){
  if(!tr.dt.value || !tr.m.value) return;
  const d=new Date(tr.dt.value);
  d.setDate(d.getDate()+1);
  const next=d.toISOString().slice(0,10);

  [...tbody.children].forEach(ntr=>{
    if(
      ntr.dt.value===next &&
      ntr.m.value.trim().toLowerCase()===tr.m.value.trim().toLowerCase() &&
      ntr.b.value.trim()===tr.b.value.trim()
    ){
      ntr.o.value=tr.cl.value;
      recalc(ntr);
    }
  });
}

/* Create row */
function createRow(d={}){
  const tr=document.createElement("tr");
  tr.innerHTML=`
<td><input type="date"></td>
<td><input></td>
<td><input placeholder=""></td>
<td><input step="0.001"></td>
<td><input step="0.001"></td>
<td><input step="0.001"></td>
<td><input readonly></td>
<td><input type="checkbox"></td>`;

  const [dt,m,b,o,c,r,cl]=tr.querySelectorAll("input");
  tr.dt=dt; tr.m=m; tr.b=b;
  tr.o=o; tr.c=c; tr.r=r; tr.cl=cl;

  dt.value=d.date||"";
  m.value=d.media||"";
  b.value=d.batch||"";
  o.value=d.opening||"";
  c.value=d.consumed||"";
  r.value=d.receipt||"";
  cl.value=d.closing||"";

  [o,c,r].forEach(i=>i.oninput=()=>recalc(tr));
  recalc(tr);
  return tr;
}

/* Initial row */
tbody.appendChild(createRow());

/* Buttons */
addRow.onclick=()=>tbody.appendChild(createRow());

addDay.onclick=()=>{
  const rows=[...tbody.children].filter(r=>r.dt.value);
  if(!rows.length)return alert("Enter date first");

  const max=rows.map(r=>r.dt.value).sort().pop();
  const d=new Date(max); d.setDate(d.getDate()+1);
  const next=d.toISOString().slice(0,10);

  rows.filter(r=>r.dt.value===max).forEach(r=>{
    tbody.appendChild(createRow({
      date:next,
      media:r.m.value,
      batch:r.b.value,
      opening:r.cl.value
    }));
  });
};

deleteSelected.onclick=()=>{
  [...tbody.children].forEach(tr=>{
    if(tr.lastElementChild.firstChild.checked) tr.remove();
  });
};

/* SAVE */
saveJson.onclick=()=>{
  const data=[...tbody.children].map(tr=>({
    date:tr.dt.value,
    media:tr.m.value,
    batch:tr.b.value,
    opening:tr.o.value,
    consumed:tr.c.value,
    receipt:tr.r.value,
    closing:tr.cl.value
  }));
  const blob=new Blob([JSON.stringify({rows:data},null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="MediaConsumption.json";
  a.click();
};

/* LOAD */
fileLoader.onchange=async e=>{
  const json=JSON.parse(await e.target.files[0].text());
  tbody.innerHTML="";
  (json.rows||[]).forEach(r=>{
    tbody.appendChild(createRow({
      date:r.date,
      media:r.media,
      batch:r.batch,
      opening:r.opening,
      consumed:r.consumed,
      receipt:r.receipt,
      closing:r.closing
    }));
  });
};

/* Report helpers */
function getRows(){
  return [...tbody.children].map(tr=>({
    date:tr.dt.value,
    media:tr.m.value,
    batch:tr.b.value,
    o:+tr.o.value||0,
    c:+tr.c.value||0,
    r:+tr.r.value||0,
    cl:+tr.cl.value||0
  }));
}

/* Media-wise summary */
mediaSummary.onclick=()=>{
  const f=fromDate.value, t=toDate.value;
  const rows=getRows().filter(r=>r.date>=f&&r.date<=t);
  const map={};
  rows.forEach(r=>{
    if(!map[r.media]) map[r.media]={o:r.o,r:0,c:0,cl:r.cl};
    map[r.media].r+=r.r;
    map[r.media].c+=r.c;
    map[r.media].cl=r.cl;
  });

  printArea.innerHTML=`
<h3>Media-wise Summary</h3>
<table>
<tr><th>Media</th><th>Opening</th><th>Receipt</th><th>Consumed</th><th>Closing</th></tr>
${Object.entries(map).map(([m,v])=>`
<tr>
<td>${m}</td>
<td>${v.o.toFixed(3)}</td>
<td>${v.r.toFixed(3)}</td>
<td>${v.c.toFixed(3)}</td>
<td>${v.cl.toFixed(3)}</td>
</tr>`).join("")}
</table>`;
};

/* Monthly report */
monthlyReport.onclick=()=>{
  const rows=getRows();
  const map={};
  rows.forEach(r=>{
    const month=r.date.slice(0,7);
    const key=r.media+"|"+month;
    map[key]=(map[key]||0)+r.c;
  });

  printArea.innerHTML=`
<h3>Monthly Consumption</h3>
<table>
<tr><th>Media</th><th>Month</th><th>Consumed</th></tr>
${Object.entries(map).map(([k,v])=>{
  const [m,mo]=k.split("|");
  return `<tr><td>${m}</td><td>${mo}</td><td>${v.toFixed(3)}</td></tr>`;
}).join("")}
</table>`;
};
</script>

</body>
</html>
