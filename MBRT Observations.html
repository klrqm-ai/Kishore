<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MBRT & PT – All Sheets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --brand: #1f4f8b;
      --brand-light: #e5f0ff;
      --brand-dark: #15355e;
      --border: #d6deec;
      --bg: #f3f6fb;
      --text: #1f2933;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top left, #ffffff 0, #f3f6fb 40%, #e6edf9 100%);
      color: var(--text);
    }

    .app-shell {
      max-width: 1500px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.4);
      overflow: hidden;
    }

    .app-header {
      padding: 14px 18px;
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .app-header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .app-header small {
      font-size: 11px;
      opacity: 0.9;
    }

    .app-header-right {
      text-align: right;
      font-size: 11px;
      opacity: 0.95;
    }

    .tab-header {
      display: flex;
      gap: 0;
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }

    .tab-header::-webkit-scrollbar {
      height: 6px;
    }
    .tab-header::-webkit-scrollbar-thumb {
      background: #cbd5f5;
      border-radius: 999px;
    }

    .tab-link {
      flex: 1 0 0;
      padding: 10px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #4b5563;
      border-right: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
      transition: background 0.15s, color 0.15s;
    }

    .tab-link span.badge {
      background: #e5edff;
      color: var(--brand-dark);
      border-radius: 999px;
      padding: 1px 8px;
      font-size: 11px;
      font-weight: 500;
    }

    .tab-link:last-child {
      border-right: none;
    }

    .tab-link:hover {
      background: #edf2ff;
    }

    .tab-link.active {
      background: #ffffff;
      color: var(--brand-dark);
      box-shadow: inset 0 -2px 0 var(--brand);
    }

    .tab-content {
      padding: 14px;
      background: #f5f7fb;
    }

    .tab-pane {
      display: none;
      background: #ffffff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }

    .tab-pane.active {
      display: block;
    }

    /* Avoid double page margins inside embedded forms */
    .tab-pane body {
      margin: 0;
      padding: 0;
      background: transparent;
    }

    .tab-pane .page,
    .tab-pane .wrap {
      box-shadow: none;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    @media (max-width: 768px) {
      body { padding: 8px; }
      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .app-header-right { text-align: left; }
      .tab-link {
        padding: 9px 10px;
        font-size: 12px;
        flex: 0 0 auto;
      }
      .tab-content { padding: 10px; }
      .tab-pane { padding: 10px; }
    }

    @media print {
      body {
        background: #ffffff;
        padding: 0;
      }
      .app-shell {
        box-shadow: none;
        border-radius: 0;
        border: none;
      }
      .app-header,
      .tab-header {
        display: none !important;
      }
      .tab-pane {
        box-shadow: none;
        padding: 0;
      }
    }
  </style>
</head>
<body>

<div class="app-shell">
  <div class="app-header">
    <div>
      <h1>HERITAGE FOODS – MBRT & PT DIGITAL LOG</h1>
      <small>Single-page access to MBRT & PT records</small>
    </div>
    <div class="app-header-right">
      <div>Ref: HFL/QA/PS/F-03</div>
      <div>Rev No: 03 • Rev Date: 22/05/2021</div>
    </div>
  </div>

  <div class="tab-header">
    <button type="button" class="tab-link active" data-target="sheet1">
      Sheet&nbsp;1 – MBRT  <span class="badge">Observations</span>
    </button>
    <button type="button" class="tab-link" data-target="sheet2">
      Sheet&nbsp;2 – PT <span class="badge">Observations
    </button>
   </div>

  <div class="tab-content">
    <!-- SHEET 1: MBRT -->
    <div id="sheet1" class="tab-pane active">
      <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MBRT Observation Record - Heritage Kalluru Unit 1216</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 16px; background-color: #f7f7f7; font-size: 14px; }
        h1 { text-align: center; margin-bottom: 10px; font-size: 20px; font-weight: bold; }
        h2 { margin-top: 20px; font-size: 16px; }
        .screen { display: none; }
        #mainScreen { display: block; }
        .controls { display: flex; justify-content: center; gap: 20px; margin-top: 30px; flex-wrap: wrap; }
        mainScreen button { padding: 12px 24px; font-size: 14px; cursor: pointer; }

        .meta-section { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 8px 16px; 
            margin-bottom: 16px; 
            background: #fff; 
            padding: 10px; 
            border-radius: 4px; 
            border: 1px solid #ccc; 
            font-size: 13px; 
        }
        .meta-field { display: flex; flex-direction: column; }
        .meta-field label { font-size: 14px; font-weight: bold; margin-bottom: 2px; }
        .meta-field input { font-size: 14px; padding: 4px 6px; }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: #fff; 
            table-layout: fixed; 
        }
        th, td { 
            border: 1px solid #000; 
            padding: 4px; 
            text-align: center; 
            font-size: 13px; 
            vertical-align: middle; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
        th { 
            background-color: #e8f0fe; 
            font-weight: bold; 
        }

        col.obs-col { width: 40px !important; }

        input[type="text"], input[type="time"], input[type="date"], textarea { 
            width: 100%; 
            padding: 2px; 
            margin: 0; 
            font-size: 13px; 
            border: none; 
            text-align: center; 
            box-sizing: border-box; 
        }
        textarea { min-height: 28px; resize: vertical; }
        .obs-cell select { 
            width: 100%; 
            font-size: 13px; 
            border: none; 
            text-align: center; 
            padding: 2px; 
        }

        .quick-actions { 
            margin-top: 12px; 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap; 
        }
        .quick-actions button { 
            padding: 8px 16px; 
            font-size: 14px; 
            cursor: pointer; 
            border-radius: 4px; 
            border: 1px solid #999; 
            background-color: #4CAF50; 
            color: white; 
        }
        .quick-actions button:hover { background-color: #45a049; }

        .controls button, .controls label { 
            padding: 6px 12px; 
            font-size: 14px; 
            cursor: pointer; 
            border-radius: 4px; 
            border: 1px solid #999; 
            background-color: #f0f0f0; 
        }
        .controls input[type="file"] { display: none; }

        #entryScreen {
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #headerTableWrapper {
            flex: 0 0 auto;
        }

        #scrollBodyWrapper {
            flex: 1 1 auto;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #000;
            border-top: none;
        }

        #scrollBodyWrapper::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #scrollBodyWrapper::-webkit-scrollbar-track {
            background: transparent;
        }
        #scrollBodyWrapper::-webkit-scrollbar-thumb {
            background-color: red;
            border-radius: 4px;
        }
        #scrollBodyWrapper {
            scrollbar-width: thin;
            scrollbar-color: red transparent;
        }

        .report-block { 
            border: 2px solid #999; 
            padding: 10px; 
            margin-bottom: 20px; 
            background: #fff; 
            page-break-inside: avoid; 
        }
        .report-header { font-size: 13px; font-weight: bold; margin-bottom: 8px; }

        #scrollTopBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 14px;
            font-size: 16px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: none;
            z-index: 1000;
        }
        #scrollTopBtn:hover {
            background-color: darkred;
        }

        @media print {
            .controls, #mainScreen, #scrollTopBtn { display: none !important; }
            body { margin: 0; }
            #entryScreen { max-height: none; overflow: visible; }
            #scrollBodyWrapper {
                max-height: none;
                overflow: visible;
                border: none;
            }
        }
    </style>
</head>

<body>

    
    <h1>MBRT Observation Record – Heritage Kalluru (Unit 1216)</h1>

    <!-- Scroll-to-top button -->
    <button id="scrollTopBtn" onclick="scrollToTop()">↑ Top</button>

    <!-- MAIN SCREEN -->
    <div id="mainScreen" class="screen" style="display: block;">
        <div class="controls">
            <button onclick="showEntry()">Entry View</button>
            <button onclick="showReport()">Report View</button>
        </div>
    </div>

    <!-- ENTRY SCREEN -->
    <div id="entryScreen" class="screen">
        <h2>Entry View</h2>

        <!-- UPDATED META SECTION (A3) -->
        <div class="meta-section">

            <!-- Row 1 -->
            <div class="meta-field">
                <label>Date</label>
                <input type="date" id="recordDate">
            </div>
            <div class="meta-field">
                <label>Product/Milk Type</label>
                <input type="text" id="product">
            </div>
            <div class="meta-field">
                <label>Shift</label>
                <input type="text" id="shift">
            </div>
            <div class="meta-field">
                <label>Analyst/Incharge</label>
                <input type="text" id="analyst">
            </div>

            <!-- Row 2 (Unit fields) -->
            <div class="meta-field">
                <label>Unit / Plant Name</label>
                <input type="text" id="unitName" value="Heritage Kalluru">
            </div>
            <div class="meta-field">
                <label>Unit Code</label>
                <input type="text" id="unitCode" value="1216">
            </div>
            <div></div>
            <div></div>
        </div>

        <!-- HEADER TABLE -->
        <div id="headerTableWrapper">
            <table id="headerTable">
                <colgroup>
                    <col style="width: 50px">
                    <col style="width: 80px">
                    <col style="width: 80px">
                    <col style="width: 70px">
                    <col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col">
                    <col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col">
                    <col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col">
                    <col style="width: 70px">
                    <col style="width: 70px">
                    <col style="width: 70px">
                    <col style="width: 60px">
                </colgroup>

                <thead>
                    <tr>
                        <th rowspan="3">S.No.</th>
                        <th rowspan="3">Location<br>Source</th>
                        <th rowspan="3">Type<br>of Milk</th>
                        <th rowspan="3">Start<br>Time</th>
                        <th colspan="15">MBRT Observation After Hrs</th>
                        <th rowspan="3">End<br>Time</th>
                        <th rowspan="3">Total<br>Hrs</th>
                        <th rowspan="3">Remark</th>
                        <th rowspan="3">Sign</th>
                    </tr>

                    <tr>
                        <th>00:30</th><th>00:45</th><th>01:00</th><th>01:15</th><th>01:30</th>
                        <th>01:45</th><th>02:00</th><th>02:15</th><th>02:30</th><th>02:45</th>
                        <th>03:00</th><th>03:15</th><th>03:30</th><th>03:45</th><th>04:00</th>
                    </tr>

                    <tr>
                        <th>04:15</th><th>04:30</th><th>04:45</th><th>05:00</th><th>05:15</th>
                        <th>05:30</th><th>05:45</th><th>06:00</th><th>06:15</th><th>06:30</th>
                        <th>06:45</th><th>07:00</th><th>07:15</th><th>07:30</th><th>07:45</th>
                    </tr>
                </thead>
            </table>
        </div>

        <!-- SCROLLABLE BODY -->
        <div id="scrollBodyWrapper">
            <table id="bodyTable">
                <colgroup>
                    <col style="width: 50px">
                    <col style="width: 80px">
                    <col style="width: 80px">
                    <col style="width: 70px">
                    <col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col">
                    <col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col">
                    <col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col"><col class="obs-col">
                    <col style="width: 70px">
                    <col style="width: 70px">
                    <col style="width: 70px">
                    <col style="width: 60px">
                </colgroup>

                <tbody id="mbrtBody"></tbody>
            </table>
        </div>

        <!-- QUICK ACTIONS -->
        <div class="quick-actions">
            <button onclick="addBatchRows(5)">Add 5 Rows</button>
            <button onclick="addBatchRows(10)">Add 10 Rows</button>
        </div>

        <div class="controls">
            <button onclick="addRow()">Add Single Row</button>
            <button onclick="deleteLastRow()">Delete Last Row</button>
            <button onclick="saveJSON()">Download JSON</button>
            <label>Load JSON
                <input type="file" id="jsonInput" accept="application/json" onchange="loadSingleJSON(event)">
            </label>
            <button onclick="window.print()">Print</button>
            <button onclick="goMain()">Back to Main</button>
        </div>
    </div>

    <!-- REPORT SCREEN -->
    <div id="reportScreen" class="screen">
        <h2>Report View (Multiple Days / Units)</h2>
        <div class="controls">
            <label>Choose JSON Files
                <input id="multiJsonInput" type="file" accept="application/json" multiple onchange="loadReportFiles(event)">
            </label>
            <button onclick="window.print()">Print</button>
            <button onclick="goMain()">Back to Main</button>
        </div>
        <div id="reportContainer"></div>
    </div>

    <!-- SCRIPT STARTS IN PART 2 -->
    <script>
        // Screen navigation
        function showEntry() {
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('reportScreen').style.display = 'none';
            document.getElementById('entryScreen').style.display = 'block';
        }

        function showReport() {
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('entryScreen').style.display = 'none';
            document.getElementById('reportScreen').style.display = 'block';
        }

        function goMain() {
            document.getElementById('entryScreen').style.display = 'none';
            document.getElementById('reportScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
        }

        // Time difference calculation
        function calcDiff(start, end) {
            if (!start || !end) return '';
            let [sh, sm] = start.split(':').map(Number);
            let [eh, em] = end.split(':').map(Number);
            let s = sh * 60 + sm;
            let e = eh * 60 + em;
            if (e < s) e += 1440;
            let d = e - s;
            let hh = String(Math.floor(d / 60)).padStart(2, '0');
            let mm = String(d % 60).padStart(2, '0');
            return `${hh}:${mm}`;
        }

        // Excel-like navigation support
        function setupNavForElement(el, rowIndex, colIndex) {
            el.classList.add('nav-cell');
            el.dataset.row = rowIndex;
            el.dataset.col = colIndex;

            el.addEventListener('keydown', function (e) {
                const key = e.key;
                const row = parseInt(el.dataset.row);
                const col = parseInt(el.dataset.col);

                let targetRow = row;
                let targetCol = col;

                if (key === 'ArrowRight') {
                    targetCol = col + 1;
                } else if (key === 'ArrowLeft') {
                    targetCol = col - 1;
                } else if (key === 'ArrowDown') {
                    targetRow = row + 1;
                } else if (key === 'ArrowUp') {
                    targetRow = row - 1;
                } else {
                    return;
                }

                e.preventDefault();
                const selector = '.nav-cell[data-row="' + targetRow + '"][data-col="' + targetCol + '"]';
                const target = document.querySelector(selector);
                if (target) {
                    target.focus();
                    if (target.select) {
                        target.select();
                    }
                }
            });
        }

        // Create logical row (two TRs per sample)
        function createRow(index) {
            const tbody = document.getElementById('mbrtBody');
            const tr1 = document.createElement('tr'); // top times 00:30–04:00
            const tr2 = document.createElement('tr'); // bottom times 04:15–07:45

            let colIndex = 1; // navigation column index

            function tdRowspan2(contentBuilder) {
                const td = document.createElement('td');
                td.rowSpan = 2;
                const element = contentBuilder(td);
                return { td, element };
            }

            // S.No.
            const snoCell = tdRowspan2(td => {
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.name = 'sno' + index;
                inp.value = index;
                td.appendChild(inp);
                setupNavForElement(inp, index, colIndex++);
                return inp;
            });
            tr1.appendChild(snoCell.td);

            // Location / Source
            const locCell = tdRowspan2(td => {
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.name = 'loc' + index;
                td.appendChild(inp);
                setupNavForElement(inp, index, colIndex++);
                return inp;
            });
            tr1.appendChild(locCell.td);

            // Type of Milk
            const typeCell = tdRowspan2(td => {
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.name = 'type' + index;
                td.appendChild(inp);
                setupNavForElement(inp, index, colIndex++);
                return inp;
            });
            tr1.appendChild(typeCell.td);

            // Start Time
            let startInput, endInput, totalInput;
            const startCell = tdRowspan2(td => {
                startInput = document.createElement('input');
                startInput.type = 'time';
                startInput.name = 'start' + index;
                startInput.classList.add('start');
                td.appendChild(startInput);
                setupNavForElement(startInput, index, colIndex++);
                return startInput;
            });
            tr1.appendChild(startCell.td);

            const selects = [];

            // Top row 15 selects (00:30–04:00)
            for (let i = 1; i <= 15; i++) {
                const td = document.createElement('td');
                td.className = 'obs-cell';
                const sel = document.createElement('select');
                sel.name = `ttop${String(i).padStart(2, '0')}${index}`;
                sel.innerHTML = '<option value=""></option><option value="Pos">Pos</option><option value="Neg">Neg</option>';
                td.appendChild(sel);
                tr1.appendChild(td);
                selects.push(sel);
                setupNavForElement(sel, index, colIndex++);
            }

            // End Time
            const endCell = tdRowspan2(td => {
                endInput = document.createElement('input');
                endInput.type = 'time';
                endInput.name = 'end' + index;
                endInput.classList.add('end');
                td.appendChild(endInput);
                setupNavForElement(endInput, index, colIndex++);
                return endInput;
            });
            tr1.appendChild(endCell.td);

            // Total Hrs
            const totalCell = tdRowspan2(td => {
                totalInput = document.createElement('input');
                totalInput.type = 'text';
                totalInput.name = 'total' + index;
                totalInput.classList.add('total');
                totalInput.readOnly = true;
                td.appendChild(totalInput);
                setupNavForElement(totalInput, index, colIndex++);
                return totalInput;
            });
            tr1.appendChild(totalCell.td);

            // Remark
            const remarkCell = tdRowspan2(td => {
                const ta = document.createElement('textarea');
                ta.name = 'remark' + index;
                td.appendChild(ta);
                setupNavForElement(ta, index, colIndex++);
                return ta;
            });
            tr1.appendChild(remarkCell.td);

            // Sign
            const signCell = tdRowspan2(td => {
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.name = 'sign' + index;
                td.appendChild(inp);
                setupNavForElement(inp, index, colIndex++);
                return inp;
            });
            tr1.appendChild(signCell.td);

            // Bottom row 15 selects (04:15–07:45)
            for (let i = 1; i <= 15; i++) {
                const td = document.createElement('td');
                td.className = 'obs-cell';
                const sel = document.createElement('select');
                sel.name = `tbot${String(i).padStart(2, '0')}${index}`;
                sel.innerHTML = '<option value=""></option><option value="Pos">Pos</option><option value="Neg">Neg</option>';
                td.appendChild(sel);
                tr2.appendChild(td);
                selects.push(sel);
                setupNavForElement(sel, index, colIndex++);
            }

            // Auto-fill Neg before first Pos across all 30 selects
            selects.forEach((sel, idx) => {
                sel.addEventListener('change', function () {
                    if (sel.value === 'Pos') {
                        for (let i = 0; i < idx; i++) {
                            if (selects[i].value === '') selects[i].value = 'Neg';
                        }
                    }
                });
            });

            // Update total time when start/end change
            function updateTotal() {
                totalInput.value = calcDiff(startInput.value, endInput.value);
            }
            startInput.addEventListener('change', updateTotal);
            endInput.addEventListener('change', updateTotal);

            tbody.appendChild(tr1);
            tbody.appendChild(tr2);
        }

        // Batch row addition
        function addBatchRows(count) {
            for (let i = 0; i < count; i++) {
                const index = Math.floor(document.getElementById('mbrtBody').children.length / 2) + 1;
                createRow(index);
            }
        }

        // Add single row
        function addRow() {
            const body = document.getElementById('mbrtBody');
            const index = Math.floor(body.children.length / 2) + 1;
            createRow(index);
        }

        // Delete last logical sample (2 TRs)
        function deleteLastRow() {
            const body = document.getElementById('mbrtBody');
            if (body.children.length >= 2) {
                body.removeChild(body.lastElementChild); // bottom row
                body.removeChild(body.lastElementChild); // top row
            }
        }

        // Build JSON filename with Unit + Date
        function buildFilename(meta) {
            const unit = (meta.unitCode || meta.unitName || 'Unit').trim().replace(/\s+/g, '');
            const date = (meta.date || 'Record').trim();
            return `MBRT_${unit}_${date}.json`;
        }

        // Save JSON
        function saveJSON() {
            const body = document.getElementById('mbrtBody');
            const data = {
                meta: {
                    date: document.getElementById('recordDate').value,
                    product: document.getElementById('product').value,
                    shift: document.getElementById('shift').value,
                    analyst: document.getElementById('analyst').value,
                    unitName: document.getElementById('unitName').value,
                    unitCode: document.getElementById('unitCode').value
                },
                rows: []
            };

            const logicalCount = Math.floor(body.children.length / 2);
            for (let idx = 1; idx <= logicalCount; idx++) {
                const row = {};
                body.querySelectorAll(`[name*="${idx}"]`).forEach(el => {
                    if (row[el.name] === undefined) row[el.name] = el.value;
                });
                data.rows.push(row);
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = buildFilename(data.meta);
            a.click();
        }

        // Load a single JSON (Entry screen)
        function loadSingleJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function () {
                const data = JSON.parse(reader.result);

                document.getElementById('recordDate').value = data.meta.date || '';
                document.getElementById('product').value = data.meta.product || '';
                document.getElementById('shift').value = data.meta.shift || '';
                document.getElementById('analyst').value = data.meta.analyst || '';
                document.getElementById('unitName').value = data.meta.unitName || 'Heritage Kalluru';
                document.getElementById('unitCode').value = data.meta.unitCode || '1216';

                const body = document.getElementById('mbrtBody');
                body.innerHTML = '';

                (data.rows || []).forEach((row, i) => {
                    const idx = i + 1;
                    createRow(idx);
                    body.querySelectorAll(`[name*="${idx}"]`).forEach(el => {
                        if (row[el.name] !== undefined) el.value = row[el.name];
                    });

                    const startVal = body.querySelector(`input.start[name="start${idx}"]`)?.value || '';
                    const endVal = body.querySelector(`input.end[name="end${idx}"]`)?.value || '';
                    const totalInput = body.querySelector(`input.total[name="total${idx}"]`);
                    if (totalInput) totalInput.value = calcDiff(startVal, endVal);
                });
            };
            reader.readAsText(file);
        }

        // Load multiple JSON files for report view
        function loadReportFiles(event) {
            const files = Array.prototype.slice.call(event.target.files);
            if (!files.length) return;

            const all = [];
            let loaded = 0;

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function () {
                    all.push(JSON.parse(reader.result));
                    loaded++;
                    if (loaded === files.length) renderReport(all);
                };
                reader.readAsText(file);
            });
        }

        // Render report blocks (minimal header: Unit + Date)
        function renderReport(records) {
            const container = document.getElementById('reportContainer');
            container.innerHTML = '';

            records.forEach(rec => {
                const block = document.createElement('div');
                block.className = 'report-block';

                const unitCode = (rec.meta && rec.meta.unitCode) || '';
                const date = (rec.meta && rec.meta.date) || '';

                block.innerHTML = `
                    <div class="report-header">
                        <strong>Unit:</strong> ${unitCode} &nbsp;&nbsp;
                        <strong>Date:</strong> ${date}
                    </div>
                `;

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>S.No.</th>
                            <th>Location/Source</th>
                            <th>Type of Milk</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Total Hrs</th>
                            <th>Remark</th>
                            <th>Sign</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;

                const tbody = table.querySelector('tbody');

                (rec.rows || []).forEach((row, i) => {
                    const idx = i + 1;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row[`sno${idx}`] || ''}</td>
                        <td>${row[`loc${idx}`] || ''}</td>
                        <td>${row[`type${idx}`] || ''}</td>
                        <td>${row[`start${idx}`] || ''}</td>
                        <td>${row[`end${idx}`] || ''}</td>
                        <td>${row[`total${idx}`] || ''}</td>
                        <td>${row[`remark${idx}`] || ''}</td>
                        <td>${row[`sign${idx}`] || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });

                block.appendChild(table);
                container.appendChild(block);
            });
        }

        // Multi-cell copy/paste like Excel
        document.addEventListener('paste', function (e) {
            const active = document.activeElement;
            if (!active.classList.contains('nav-cell')) return;

            e.preventDefault();

            const text = (e.clipboardData || window.clipboardData).getData('text');
            const rows = text.split(/\r?\n/).filter(r => r.trim() !== '');

            const startRow = parseInt(active.dataset.row);
            const startCol = parseInt(active.dataset.col);

            rows.forEach((rowText, rIndex) => {
                const cols = rowText.split(/\t/);

                cols.forEach((value, cIndex) => {
                    const target = document.querySelector(
                        `.nav-cell[data-row="${startRow + rIndex}"][data-col="${startCol + cIndex}"]`
                    );
                    if (target) {
                        target.value = value.trim();
                        target.dispatchEvent(new Event('change'));
                    }
                });
            });
        });

        // Scroll-to-top logic
        const scrollBodyWrapper = document.getElementById('scrollBodyWrapper');
        const scrollBtn = document.getElementById('scrollTopBtn');

        if (scrollBodyWrapper) {
            scrollBodyWrapper.addEventListener('scroll', function () {
                scrollBtn.style.display = scrollBodyWrapper.scrollTop > 200 ? 'block' : 'none';
            });
        }

        function scrollToTop() {
            if (scrollBodyWrapper) {
                scrollBodyWrapper.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Initialize with 5 rows and default Heritage Kalluru / 1216 values
        window.onload = function () {
            showEntry();
            addBatchRows(5);

            const unitNameInput = document.getElementById('unitName');
            const unitCodeInput = document.getElementById('unitCode');

            if (unitNameInput && !unitNameInput.value) {
                unitNameInput.value = 'Heritage Kalluru';
            }
            if (unitCodeInput && !unitCodeInput.value) {
                unitCodeInput.value = '1216';
            }
        };
    </script>
</body>
</html>
    </div>

    <!-- SHEET 2: PT -->
    <div id="sheet2" class="tab-pane">
      <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HERITAGE FOODS LIMITED QA — Phosphatase Test Report</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input[type="text"], input[type="time"], select {
  width: 100%;
  padding: 6px;
  box-sizing: border-box;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
}

input:focus, select:focus {
  border-color: #3b82f6;
  outline: none;
  background: #f0f9ff;
}
tbody tr:nth-child(even) {
  background: #f9fafb;
}
tbody tr:nth-child(odd) {
  background: #ffffff;
}
th {
  background: #e8f0fe;
  color: #1e3a8a;
  font-weight: 600;
}
    header { text-align: center; border-bottom: 2px solid #333; margin-bottom: 16px; color: #fd7e14; }
    header h1 { margin: 0; font-size: 22px; color: #fd7e14; }
    header h2 { margin: 4px 0 0; font-size: 16px; color: #fd7e14; }

    .meta {
      display: flex; justify-content: center; gap: 40px;
      margin: 12px 0 20px; font-size: 14px;
    }
    .meta div { white-space: nowrap; }

    .toolbar { text-align: center; margin: 14px 0 18px; }
    .toolbar button { margin: 0 6px; padding: 8px 12px; font-size: 14px; }

    /* Scrollable container */
    .table-container {
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #ccc;
    }

    /* Table layout fixed for stable column widths */
    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      word-wrap: break-word;
    }

    th { background: #eef; }

    /* Sticky header rows */
    thead tr:nth-child(1) th {
      position: sticky;
      top: 0;
      background: #eef;
      z-index: 5;
    }

    thead tr:nth-child(2) th {
      position: sticky;
      top: 32px;
      background: #eef;
      z-index: 4;
    }

    thead tr:nth-child(3) th {
      position: sticky;
      top: 64px;
      background: #eef;
      z-index: 3;
    }

    /* Column width definitions (medium size) */
    th:nth-child(1), td:nth-child(1) { width: 100px; } /* Location */
    th:nth-child(2), td:nth-child(2) { width: 100px; } /* Type of milk */
    th:nth-child(3), td:nth-child(3) { width: 100px; } /* Start time */

    /* Observation columns (7 columns) */
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5),
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7),
    th:nth-child(8), td:nth-child(8),
    th:nth-child(9), td:nth-child(9),
    th:nth-child(10), td:nth-child(10) {
      width: 95px;
    }

    th:nth-child(11), td:nth-child(11) { width: 100px; } /* End time */
    th:nth-child(12), td:nth-child(12) { width: 100px; } /* Total hours */
    th:nth-child(13), td:nth-child(13) { width: 120px; } /* Remark */
    th:nth-child(14), td:nth-child(14) { width: 80px; }  /* Sign */

    input[type="text"], input[type="time"], select {
  width: 100%;
  padding: 4px;
  box-sizing: border-box;
}

    @media print {
      .toolbar { display: none; }
      .table-container { max-height: none; overflow: visible; }
      thead th { position: static; }
    }
  </style>
</head>

<body>

  <header>
    <h1>HERITAGE FOODS LIMITED — QUALITY ASSURANCE</h1>
    <h2>Phosphatase Test Report</h2>
  </header>

  <div class="meta">
    <div>Rev. No.: <strong>03</strong></div>
    <div>Rev. Date: <strong>22.05.2021</strong></div>
    <div>Ref. No.: <strong>HFL/QA/PS/F-03</strong></div>
    <div>Record Date: <input type="text" id="recordDate" placeholder="DD.MM.YYYY" /></div>
  </div>

  <div class="toolbar">
    <button onclick="addRow()">Add row</button>
    <button onclick="saveData()">Save</button>
    <button onclick="loadData()">Load</button>
    <button onclick="window.print()">Print</button>
  </div>

  <div class="table-container">
    <table id="ptTable">
      <thead>
        <tr><th colspan="14">PHOSPHATASE</th></tr>

        <tr>
          <th rowspan="2">Location / Source</th>
          <th rowspan="2">Type of milk</th>
          <th rowspan="2">Start time</th>
          <th colspan="7">Observation after (hrs)</th>
          <th rowspan="2">End time</th>
          <th rowspan="2">Total hours</th>
          <th rowspan="2">Remark</th>
          <th rowspan="2">Sign</th>
        </tr>

        <tr>
          <th>00:30</th><th>00:45</th><th>01:00</th>
          <th>01:15</th><th>01:30</th><th>01:45</th><th>02:00</th>
        </tr>
      </thead>

      <tbody id="ptBody"></tbody>
    </table>
  </div>

<script>
function obsCell(selected='') {
  return `<td>
    <select>
      <option value="">Select</option>
      <option ${selected==='Negative'?'selected':''}>Negative</option>
      <option ${selected==='Trace'?'selected':''}>Trace</option>
      <option ${selected==='Positive'?'selected':''}>Positive</option>
    </select>
  </td>`;
}

function addRow(prefill=null) {
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input type="text" value="${prefill?.location||''}" placeholder=""/></td>
    <td><input type="text" value="${prefill?.milkType||''}" placeholder=""/></td>
    <td><input type="time" class="start" value="${prefill?.startTime||''}"/></td>
    ${Array(7).fill(0).map((_,i)=>obsCell(prefill?.obs?.[i]||'')).join('')}
    <td><input type="time" class="end" value="${prefill?.endTime||''}"/></td>
    <td><input type="text" class="total" value="${prefill?.totalHours||''}" readonly/></td>
    <td><input type="text" value="${prefill?.remark||''}" placeholder=""/></td>
    <td><input type="text" value="${prefill?.sign||''}" placeholder=""/></td>`;
  document.getElementById('ptBody').appendChild(tr);

  const start=tr.querySelector('.start'),
        end=tr.querySelector('.end'),
        total=tr.querySelector('.total');

  [start,end].forEach(el=>el.addEventListener('change',()=>{
    total.value=calcHours(start.value,end.value);
  }));
}

function calcHours(start,end){
  if(!start||!end) return '';
  const [sh,sm]=start.split(':').map(Number),
        [eh,em]=end.split(':').map(Number);
  let s=sh*60+sm, e=eh*60+em;
  if(e<s) e+=24*60;
  const diff=e-s, h=Math.floor(diff/60), m=diff%60;
  return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');
}

function saveData(){
  const rows=[];
  document.querySelectorAll('#ptBody tr').forEach(tr=>{
    const c=tr.querySelectorAll('td');
    rows.push({
      location:c[0].querySelector('input').value,
      milkType:c[1].querySelector('input').value,
      startTime:c[2].querySelector('input').value,
      obs:Array.from(c).slice(3,10).map(td=>td.querySelector('select').value),
      endTime:c[10].querySelector('input').value,
      totalHours:c[11].querySelector('input').value,
      remark:c[12].querySelector('input').value,
      sign:c[13].querySelector('input').value
    });
  });

  const meta={
    revNo:'03', revDate:'22.05.2021', refNo:'HFL/QA/PS/F-03',
    recordDate:document.getElementById('recordDate').value
  };

  const blob=new Blob([JSON.stringify({meta,rows},null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='phosphatase_report.json';
  a.click();
}

function loadData(){
  const input=document.createElement('input');
  input.type='file';
  input.accept='application/json';

  input.onchange=async()=>{
    const file=input.files[0];
    if(!file) return;
    const text=await file.text();
    const {meta,rows}=JSON.parse(text);

    document.getElementById('recordDate').value=meta?.recordDate||'';

    const tbody=document.getElementById('ptBody');
    tbody.innerHTML='';
    (rows||[]).forEach(r=>addRow(r));
  };

  input.click();
}

// start with one row
addRow();
</script>

</body>
</html>
    </div>

    <!-- SHEET 3: Curd CCP & OPRP -->
    <div id="sheet3" class="tab-pane">
      <!-- === PASTE FULL CURD-CCP-OPRP.html content BELOW === -->
    </div>
  </div>
</div>

<script>
  document.querySelectorAll('.tab-link').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var targetId = this.getAttribute('data-target');

      document.querySelectorAll('.tab-link').forEach(function (b) {
        b.classList.remove('active');
      });
      this.classList.add('active');

      document.querySelectorAll('.tab-pane').forEach(function (pane) {
        pane.classList.remove('active');
      });
      var pane = document.getElementById(targetId);
      if (pane) { pane.classList.add('active'); }
    });
  });
</script>

</body>
</html>
