<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CIP Test Report Generator</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 20px;
}

#uploader, #dateBox {
    margin-bottom: 20px;
    padding: 12px;
    border: 2px dashed #555;
    width: 380px;
    text-align: center;
    cursor: pointer;
}

#dateSelect {
    padding: 6px;
    font-size: 14px;
    width: 260px;
}

.page {
    width: 8.5in;
    height: 5.5in;
    padding: 20px;
    box-sizing: border-box;
    border: 1px solid #000;
    margin: 20px auto;
    page-break-after: always;
}

h2, h3 {
    text-align: center;
    margin: 0;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 13px;
}

td, th {
    border: 1px solid #000;
    padding: 5px;
}

.no-border td {
    border: none;
    padding: 2px;
}

.sign td {
    padding-top: 30px;
    text-align: center;
}

.error {
    color: red;
    font-weight: bold;
    margin-top: 10px;
}

@media print {
    #uploader, #dateBox, .error {
        display: none;
    }
    .page {
        border: none;
        margin: 0;
    }
}
</style>
</head>

<body>

<h2>CIP TEST REPORT GENERATOR</h2>

<div id="uploader"><b>Click to upload CIP JSON file</b></div>
<input type="file" id="fileInput" accept=".json" style="display:none;">

<div id="dateBox" style="display:none;">
    <b>Select Date(s)</b><br><br>
    <select id="dateSelect" multiple size="6"></select><br><br>
    <small>Hold Ctrl / Shift for multiple dates</small>
</div>

<div id="error" class="error"></div>
<div id="output"></div>

<script>
let jsonData = [];
let headerStatus = {};

document.getElementById("uploader").onclick = () =>
    document.getElementById("fileInput").click();

/* Shift detection */
function detectShift(time) {
    if (!time) return "-";
    const [h, m] = time.split(":").map(Number);
    const minutes = h * 60 + m;
    if (minutes >= 360 && minutes < 840) return "A";
    if (minutes >= 840 && minutes < 1320) return "B";
    return "C";
}

/* File load */
document.getElementById("fileInput").addEventListener("change", function () {
    const errorBox = document.getElementById("error");
    errorBox.textContent = "";

    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const parsed = JSON.parse(e.target.result);

            if (!parsed.records || !Array.isArray(parsed.records)) {
                throw "JSON must contain 'records' array";
            }

            jsonData = parsed.records;
            headerStatus = parsed.headerStatus || {};

            const dates = [...new Set(
                jsonData.map(r => (r.date || "").trim())
            )].filter(Boolean);

            const dateSelect = document.getElementById("dateSelect");
            dateSelect.innerHTML = "";

            dates.forEach(d => {
                const opt = document.createElement("option");
                opt.value = d;
                opt.textContent = d;
                dateSelect.appendChild(opt);
            });

            document.getElementById("dateBox").style.display = "block";
        } catch (err) {
            errorBox.textContent = "Invalid JSON file format!";
            console.error(err);
        }
    };
    reader.readAsText(file);
});

/* Date change */
document.getElementById("dateSelect").addEventListener("change", function () {
    const selectedDates = [...this.selectedOptions].map(o => o.value);
    generateReports(selectedDates);
});

/* Report generation */
function generateReports(selectedDates) {
    const output = document.getElementById("output");
    output.innerHTML = "";

    if (!selectedDates.length) return;

    const filtered = jsonData.filter(r =>
        selectedDates.includes((r.date || "").trim())
    );

    filtered.forEach(r => {
        const shift = detectShift(r.start);

        output.innerHTML += `
        <div class="page">

        <table class="no-border">
            <tr>
                <td style="width:20%">
                    <img src="heritage_logo.png"
                         onerror="this.style.display='none'"
                         height="60">
                </td>
                <td style="text-align:center">
                    <h2>HERITAGE FOODS LIMITED</h2>
                    <h3>TEST REPORT ON WATER / CIP</h3>
                </td>
                <td style="width:20%"></td>
            </tr>
        </table>

        <table class="no-border">
            <tr>
                <td><b>REF.NO:</b> HFL/QA/PS/F-02</td>
                <td><b>REV.NO:</b> 02</td>
                <td><b>REV.DATE:</b> 01.07.2017</td>
            </tr>
            <tr>
                <td colspan="3">
                    <b>Status:</b>
                    Approved=${headerStatus.approved || "-"},
                    Locked=${headerStatus.locked || "-"}
                </td>
            </tr>
        </table>

        <table>
            <tr><th colspan="3">Date: ${r.date}</th></tr>
            <tr>
                <th>Shift</th>
                <th>Time</th>
                <th>Source</th>
            </tr>
            <tr>
                <td>${shift}</td>
                <td>${r.start || ""} - ${r.end || ""}</td>
                <td>${r.resource || ""}</td>
            </tr>

            <tr><td>Sample Description</td><td colspan="2">${r.type || ""}</td></tr>
            <tr><td>NaOH (1st) (%)</td><td colspan="2">${r.c1s || ""}</td></tr>
            ${r.c2s ? `<tr><td>NaOH (2nd) (%)</td><td colspan="2">${r.c2s}</td></tr>` : ""}
            <tr><td>HNO₃ (%)</td><td colspan="2">${r.ns || ""}</td></tr>
            <tr><td>Temperature (°C)</td><td colspan="2">${r.hwt || ""}</td></tr>
            <tr><td>Remarks</td><td colspan="2">${r.residue || ""}</td></tr>
        </table>

        <table class="sign">
            <tr>
                <td>Shift I/C OPN</td>
                <td>Shift I/C QA</td>
            </tr>
        </table>

        </div>`;
    });
}
</script>

</body>
</html>
