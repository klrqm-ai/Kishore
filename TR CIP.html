<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CIP Test Report Generator</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #uploader, #dateBox, #printBox { margin-bottom: 20px; padding: 10px; border: 2px dashed #666; width: 350px; text-align: center; cursor: pointer; }
    #dateSelect { padding: 6px; font-size: 14px; width: 200px; }
    .page { width: 8.5in; height: 5.5in; padding: 20px; box-sizing: border-box; border: 1px solid #000; margin: 20px auto; page-break-after: always; }
    h2, h3 { text-align: center; margin: 0; padding: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
    td, th { border: 1px solid #000; padding: 5px; }
    .no-border td { border: none; padding: 2px; }
    .sign td { padding-top: 25px; text-align: center; }
    @media print { #uploader, #dateBox, #printBox { display: none; } .page { border: none; margin: 0; } }
</style>
</head>
<body>

<h2>CIP TEST REPORT GENERATOR</h2>

<div id="uploader"><b>Click to upload CIP JSON files</b></div>
<input type="file" id="fileInput" accept=".json" multiple style="display:none;">
<div id="dateBox" style="display:none;">
    <b>Select Date:</b><br><br>
    <select id="dateSelect"></select>
</div>
<div id="printBox" style="display:none;">
    <button onclick="printReports()">Print Reports</button>
</div>
<div id="output"></div>

<script>
let jsonData = [];
let headerStatus = {};

document.getElementById("uploader").onclick = () => {
    document.getElementById("fileInput").click();
};

function detectShift(time) {
    if (!time) return "-";
    const [h, m] = time.split(":").map(Number);
    const minutes = h * 60 + m;
    if (minutes >= 360 && minutes < 840) return "A";   // 06–14
    if (minutes >= 840 && minutes < 1320) return "B";  // 14–22
    return "C";                                        // 22–06
}

document.getElementById("fileInput").addEventListener("change", function() {
    const files = Array.from(this.files);
    jsonData = [];
    headerStatus = {};

    let promises = files.map(file => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsed = JSON.parse(e.target.result);
                    jsonData = jsonData.concat(parsed.records || []);
                    Object.assign(headerStatus, parsed.headerStatus || {});
                    resolve();
                } catch (err) {
                    reject(err);
                }
            };
            reader.readAsText(file);
        });
    });

    Promise.all(promises).then(() => {
        const dates = [...new Set(jsonData.map(r => r.date))];
        const dateSelect = document.getElementById("dateSelect");
        dateSelect.innerHTML = "";

        dates.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d;
            opt.textContent = d;
            dateSelect.appendChild(opt);
        });

        document.getElementById("dateBox").style.display = "block";
        document.getElementById("printBox").style.display = "block";
        generateReports(dateSelect.value);
    });
});

document.getElementById("dateSelect").addEventListener("change", function() {
    generateReports(this.value);
});

function generateReports(selectedDate) {
    const output = document.getElementById("output");
    output.innerHTML = "";

    const filtered = jsonData.filter(r => r.date === selectedDate);

    filtered.forEach((r) => {
        const shift = detectShift(r.start);

        output.innerHTML += `
        <div class="page">
            <table style="width:100%; border:none;">
                <tr>
                    <td style="width:20%; text-align:left; border:none;">
                        <img src="heritage_logo.png" alt="Heritage Foods Limited" style="height:60px;">
                    </td>
                    <td style="text-align:center; border:none;">
                        <h2>HERITAGE FOODS LIMITED</h2>
                        <h3>TEST REPORT ON WATER / CIP</h3>
                    </td>
                    <td style="width:20%; border:none;"></td>
                </tr>
            </table>

            <table class="no-border">
                <tr>
                    <td><b>REF.NO:</b> HFL/QA/PS/F-02</td>
                    <td><b>REV.NO:</b> 02</td>
                    <td><b>REV.DATE:</b> 01.07.2017</td>
                </tr>
                <tr>
                    <td colspan="3"><b>Status:</b> Approved=${headerStatus.approved}, Locked=${headerStatus.locked}</td>
                </tr>
            </table>

            <table>
                <tr><th colspan="3">Date: ${selectedDate}</th></tr>
                <tr><th>Shift</th><th>Time</th><th>Source</th></tr>
                <tr>
                    <td>${shift}</td>
                    <td>${r.start || ""} - ${r.end || ""}</td>
                    <td>${r.resource}</td>
                </tr>

                <tr><td>Sample Description</td><td colspan="2">${r.type}</td></tr>
                <tr><td>NaOH (1st) (%)</td><td colspan="2">${r.c1s || ""}</td></tr>
                ${r.c2s ? `<tr><td>NaOH (2nd) (%)</td><td colspan="2">${r.c2s}</td></tr>` : ""}
                <tr><td>HNO₃ (%)</td><td colspan="2">${r.ns || ""}</td></tr>
                <tr><td>TEMPERATURE (°C)</td><td colspan="2">${r.hwt || ""}</td></tr>
                <tr><td>Remarks</td><td colspan="2">${r.residue || ""}</td></tr>
            </table>

            <table class="sign">
                <tr>
                    <td>Shift I/C OPN</td>
                    <td>Shift I/C QA</td>
                </tr>
            </table>
        </div>
        `;
    });
}

function printReports() {
    window.print();
}
</script>
</body>
</html>

